import Head from 'next/head';
import { useEffect } from 'react';

const CSS = "\n:root {\n  --green-dark:  #1E3D2F;\n  --green-mid:   #2A6041;\n  --green-light: #4A9B6F;\n  --green-pale:  #E8F5EE;\n  --gold:        #C8790A;\n  --gold-pale:   #FFF8E1;\n  --surface:     #F0EDE6;\n  --stroke:      #E2DDD5;\n  --white:       #FFFFFF;\n  --off-white:   #F8F6F1;\n  --text-dark:   #1A1A1A;\n  --text-mid:    #4A4A4A;\n  --text-light:  #8A8A8A;\n  --error:       #B71C1C;\n  --whatsapp:    #25D366;\n  --blue:        #1565C0;\n  --blue-pale:   #E3F2FD;\n  --shadow:      0 2px 16px rgba(30,61,47,0.09);\n  --shadow-lg:   0 8px 40px rgba(30,61,47,0.14);\n  --r:           16px;\n  --r-sm:        10px;\n}\n*{box-sizing:border-box;margin:0;padding:0;}\nbody{font-family:'Sora',sans-serif;background:var(--off-white);color:var(--text-dark);min-height:100vh;}\n.sidebar{position:fixed;top:0;left:0;width:240px;height:100vh;background:var(--green-dark);display:flex;flex-direction:column;padding:0;z-index:200;}\n.sidebar-logo{padding:26px 24px 22px;border-bottom:1px solid rgba(255,255,255,0.08);}\n.sidebar-logo h1{font-size:19px;font-weight:800;color:#fff;letter-spacing:-.4px;}\n.sidebar-logo span{font-size:11px;color:rgba(255,255,255,.4);display:block;margin-top:2px;}\n.sidebar-nav{padding:16px 12px;flex:1;display:flex;flex-direction:column;gap:3px;}\n.nav-item{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--r-sm);color:rgba(255,255,255,.5);font-size:13.5px;font-weight:500;cursor:pointer;transition:all .18s;text-decoration:none;border:none;background:transparent;font-family:'Sora',sans-serif;width:100%;}\n.nav-item:hover{background:rgba(255,255,255,.07);color:#fff;}\n.nav-item.active{background:rgba(74,155,111,.22);color:#fff;}\n.nav-item svg{width:16px;height:16px;flex-shrink:0;}\n.main{margin-left:240px;padding:36px 40px;min-height:100vh;}\n.tab-page{display:none;}.tab-page.active{display:block;}\n.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;gap:16px;}\n.page-header h2{font-size:26px;font-weight:800;color:var(--green-dark);letter-spacing:-.5px;}\n.page-header p{font-size:13px;color:var(--text-light);margin-top:3px;}\n.header-actions{display:flex;gap:8px;align-items:center;}\n.lang-btn button{padding:8px 16px;border-radius:8px;border:1px solid var(--stroke);background:var(--white);font-family:'Sora',sans-serif;font-size:12px;font-weight:600;color:var(--text-mid);cursor:pointer;transition:all .18s;}\n.lang-btn button.active{background:var(--green-mid);color:#fff;border-color:var(--green-mid);}\n.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}\n.stat-card{background:var(--white);border:1px solid var(--stroke);border-radius:var(--r);padding:20px 22px;box-shadow:var(--shadow);transition:transform .2s,box-shadow .2s;position:relative;overflow:hidden;}\n.stat-card::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;border-radius:4px 0 0 4px;}\n.stat-card.revenue::before{background:var(--green-mid);}\n.stat-card.new-c::before{background:var(--blue);}\n.stat-card.confirmed::before{background:var(--gold);}\n.stat-card.delivered::before{background:var(--green-light);}\n.stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);}\n.stat-card .s-label{font-size:11px;color:var(--text-light);font-weight:600;text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;}\n.stat-card .s-value{font-size:28px;font-weight:800;letter-spacing:-1px;}\n.stat-card.revenue .s-value{color:var(--green-dark);}\n.stat-card.new-c .s-value{color:var(--blue);}\n.stat-card.confirmed .s-value{color:var(--gold);}\n.stat-card.delivered .s-value{color:var(--green-light);}\n.stat-card .s-sub{font-size:11px;color:var(--text-light);margin-top:4px;}\n.stat-card .s-trend{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:600;padding:2px 7px;border-radius:20px;margin-top:6px;}\n.s-trend.up{background:#E8F5EE;color:var(--green-mid);}\n.s-trend.down{background:#FFEBEE;color:var(--error);}\n.period-bar{display:flex;gap:6px;background:var(--surface);padding:4px;border-radius:var(--r-sm);border:1px solid var(--stroke);width:fit-content;margin-bottom:24px;}\n.period-btn{padding:7px 16px;border-radius:8px;border:none;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;color:var(--text-light);cursor:pointer;background:transparent;transition:all .18s;}\n.period-btn.active{background:var(--white);color:var(--green-dark);box-shadow:0 1px 8px rgba(0,0,0,.08);}\n.two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}\n.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px;}\n.wide-narrow{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;}\n.section-card{background:var(--white);border:1px solid var(--stroke);border-radius:var(--r);padding:18px 20px;box-shadow:var(--shadow);}\n.section-card h3{font-size:14px;font-weight:800;color:var(--green-dark);letter-spacing:-.2px;}\n.section-sub{font-size:12px;color:var(--text-light);margin-top:4px;}\n.seg-ctrl{display:flex;background:var(--surface);border:1px solid var(--stroke);border-radius:var(--r-sm);padding:3px;gap:2px;}\n.seg-btn{padding:6px 14px;border-radius:7px;border:none;font-family:'Sora',sans-serif;font-size:12px;font-weight:600;color:var(--text-light);cursor:pointer;background:transparent;transition:all .18s;}\n.seg-btn.active{background:var(--white);color:var(--green-dark);box-shadow:0 1px 6px rgba(0,0,0,.08);}\n.table-shell{margin-top:12px;background:var(--white);border:1px solid var(--stroke);border-radius:14px;overflow:hidden;}\n.table-scroll{overflow:auto;max-width:100%;-webkit-overflow-scrolling:touch;}\n.top-table{width:100%;border-collapse:separate;border-spacing:0;min-width:780px;}\n.top-table thead th{position:sticky;top:0;z-index:2;background:linear-gradient(#ffffff,#fbfaf7);font-size:11px;font-weight:800;color:var(--text-light);text-transform:uppercase;letter-spacing:.6px;padding:12px 14px;text-align:left;border-bottom:1px solid var(--stroke);white-space:nowrap;}\n.top-table tbody td{padding:12px 14px;font-size:13px;color:var(--text-mid);border-bottom:1px solid rgba(226,221,213,.85);vertical-align:middle;}\n.top-table tbody tr:nth-child(even){background:#FCFBF8;}\n.top-table tbody tr:hover{background:#F3F1EC;}\n.top-table tbody tr:last-child td{border-bottom:none;}\n.top-table th:last-child,.top-table td:last-child{text-align:right;}\n.top-table th:nth-last-child(2),.top-table td:nth-last-child(2){text-align:left;}\n.cell-mono{font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--text-mid);}\n.cell-rank{width:56px;}\n.cell-rank .rank-pill{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;background:var(--surface);color:var(--green-dark);border:1px solid var(--stroke);}\n.prod-name{color:var(--text-dark);font-weight:700;}\n.prod-cat{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:800;padding:4px 10px;border-radius:999px;border:1px solid rgba(0,0,0,.06);white-space:nowrap;}\n.rev-val{font-weight:900;color:var(--green-dark);white-space:nowrap;}\n.share-wrap{display:flex;align-items:center;gap:10px;justify-content:flex-end;}\n.prog-bar-wrap{width:110px;background:var(--surface);border-radius:999px;height:8px;overflow:hidden;border:1px solid rgba(0,0,0,.04);}\n.prog-bar{height:100%;border-radius:999px;background:var(--green-mid);transition:width 1s ease;}\n.share-pct{font-size:11px;color:var(--text-light);min-width:34px;text-align:right;}\n.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;}\n.filter-tabs{display:flex;gap:7px;flex-wrap:wrap;flex:1;}\n.filter-tab{padding:8px 16px;border-radius:20px;border:1px solid var(--stroke);background:var(--white);font-family:'Sora',sans-serif;font-size:12.5px;font-weight:500;color:var(--text-mid);cursor:pointer;transition:all .18s;display:flex;align-items:center;gap:5px;}\n.filter-tab:hover{border-color:var(--green-mid);color:var(--green-mid);}\n.filter-tab.active{background:var(--green-mid);color:#fff;border-color:var(--green-mid);font-weight:600;}\n.filter-tab .badge{background:rgba(255,255,255,.25);padding:1px 7px;border-radius:10px;font-size:11px;font-weight:700;}\n.filter-tab:not(.active) .badge{background:var(--green-pale);color:var(--green-mid);}\n.search-box{display:flex;align-items:center;gap:8px;background:var(--white);border:1px solid var(--stroke);border-radius:var(--r-sm);padding:9px 14px;min-width:200px;}\n.search-box input{border:none;outline:none;font-family:'Sora',sans-serif;font-size:13px;color:var(--text-dark);background:transparent;width:100%;}\n.search-box input::placeholder{color:var(--text-light);}\n.refresh-btn{padding:9px 14px;border-radius:var(--r-sm);border:1px solid var(--stroke);background:var(--white);cursor:pointer;display:flex;align-items:center;gap:6px;font-family:'Sora',sans-serif;font-size:13px;color:var(--text-mid);transition:all .18s;}\n.refresh-btn:hover{border-color:var(--green-mid);color:var(--green-mid);}\n.orders-grid{display:grid;gap:14px;}\n.order-card{background:var(--white);border:1px solid var(--stroke);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden;transition:box-shadow .2s,transform .2s;animation:fadeUp .3s ease both;}\n.order-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px);}\n@keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}\n.order-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px 13px;border-bottom:1px solid var(--stroke);}\n.order-id{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600;color:var(--green-dark);}\n.order-date{font-size:11.5px;color:var(--text-light);margin-top:2px;}\n.status-badge{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:20px;font-size:11.5px;font-weight:700;}\n.status-badge.new{background:var(--blue-pale);color:var(--blue);}\n.status-badge.confirmed{background:var(--gold-pale);color:var(--gold);}\n.status-badge.delivered{background:var(--green-pale);color:var(--green-mid);}\n.status-badge.cancelled{background:#FFEBEE;color:var(--error);}\n.order-body{padding:16px 20px;}\n.customer-info{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:14px;}\n.customer-info .field{display:flex;align-items:center;gap:6px;font-size:12.5px;color:var(--text-mid);}\n.customer-info .field svg{color:var(--green-mid);flex-shrink:0;}\n.customer-info .field strong{color:var(--text-dark);font-weight:600;}\n.items-table{width:100%;border-collapse:collapse;margin-bottom:12px;}\n.items-table tr{border-bottom:1px solid var(--stroke);}\n.items-table tr:last-child{border-bottom:none;}\n.items-table td{padding:8px 0;font-size:12.5px;color:var(--text-mid);}\n.items-table td.item-name{color:var(--text-dark);font-weight:500;}\n.items-table td.item-price{text-align:right;font-weight:700;color:var(--green-dark);white-space:nowrap;}\n.order-footer{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:var(--off-white);border-top:1px solid var(--stroke);gap:12px;flex-wrap:wrap;}\n.order-total .total-label{font-size:10px;color:var(--text-light);font-weight:500;}\n.order-total .total-value{font-size:20px;font-weight:800;color:var(--green-dark);letter-spacing:-.5px;}\n.order-actions{display:flex;gap:7px;flex-wrap:wrap;}\n.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:var(--r-sm);font-family:'Sora',sans-serif;font-size:12.5px;font-weight:600;cursor:pointer;transition:all .18s;border:none;white-space:nowrap;}\n.btn svg{width:13px;height:13px;}\n.btn-whatsapp{background:var(--whatsapp);color:#fff;}\n.btn-whatsapp:hover{background:#1da84e;}\n.btn-phone{background:var(--white);color:var(--green-mid);border:1px solid var(--stroke);}\n.btn-phone:hover{border-color:var(--green-mid);background:var(--green-pale);}\n.btn-confirm{background:var(--gold-pale);color:var(--gold);border:1px solid #f5d080;}\n.btn-confirm:hover{background:#fdeea0;}\n.btn-deliver{background:var(--green-pale);color:var(--green-mid);border:1px solid #b2ddc4;}\n.btn-deliver:hover{background:#cceedd;}\n.btn-cancel{background:#FFEBEE;color:var(--error);border:1px solid #ffcdd2;}\n.btn-cancel:hover{background:#ffcdd2;}\n.empty-state{text-align:center;padding:70px 40px;color:var(--text-light);}\n.empty-state .emoji{font-size:44px;margin-bottom:14px;}\n.empty-state h3{font-size:17px;font-weight:700;color:var(--text-mid);margin-bottom:6px;}\n.loading-state{display:flex;align-items:center;justify-content:center;padding:70px;gap:12px;color:var(--text-light);}\n.spinner{width:22px;height:22px;border:3px solid var(--stroke);border-top-color:var(--green-mid);border-radius:50%;animation:spin .65s linear infinite;}\n@keyframes spin{to{transform:rotate(360deg);}}\n.toast{position:fixed;bottom:26px;right:26px;background:var(--green-dark);color:#fff;padding:12px 20px;border-radius:var(--r-sm);font-size:13px;font-weight:600;box-shadow:var(--shadow-lg);transform:translateY(80px);opacity:0;transition:all .35s cubic-bezier(.34,1.56,.64,1);z-index:9999;}\n.toast.show{transform:translateY(0);opacity:1;}\n#login-screen{position:fixed;inset:0;z-index:9999;background:var(--green-dark);display:flex;align-items:center;justify-content:center;font-family:'Sora',sans-serif;}\n#login-screen.hidden{display:none;}\n.login-bg{position:absolute;inset:0;overflow:hidden;pointer-events:none;}\n.login-bg-circle{position:absolute;border-radius:50%;opacity:.07;}\n.login-bg-circle.c1{width:520px;height:520px;background:#4A9B6F;top:-120px;right:-100px;}\n.login-bg-circle.c2{width:380px;height:380px;background:#C8790A;bottom:-80px;left:-80px;}\n.login-bg-circle.c3{width:200px;height:200px;background:#fff;top:40%;left:12%;}\n.login-box{position:relative;z-index:2;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:24px;padding:48px 44px;width:100%;max-width:400px;backdrop-filter:blur(20px);box-shadow:0 24px 80px rgba(0,0,0,.35);animation:loginFadeIn .5s ease both;}\n@keyframes loginFadeIn{from{opacity:0;transform:translateY(28px) scale(.97);}to{opacity:1;transform:translateY(0) scale(1);}}\n.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;}\n.login-logo .logo-icon{width:46px;height:46px;border-radius:14px;background:rgba(74,155,111,.25);border:1px solid rgba(74,155,111,.4);display:flex;align-items:center;justify-content:center;font-size:22px;}\n.login-logo .logo-text h1{font-size:18px;font-weight:800;color:#fff;letter-spacing:-.3px;}\n.login-logo .logo-text span{font-size:11px;color:rgba(255,255,255,.4);display:block;margin-top:1px;}\n.login-title{font-size:22px;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:-.4px;}\n.login-sub{font-size:13px;color:rgba(255,255,255,.45);margin-bottom:28px;}\n.login-field{margin-bottom:16px;}\n.login-field label{display:block;font-size:11.5px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:7px;text-transform:uppercase;letter-spacing:.6px;}\n.login-input-wrap{position:relative;display:flex;align-items:center;}\n.login-input{width:100%;padding:13px 44px 13px 16px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.14);border-radius:12px;color:#fff;font-family:'Sora',sans-serif;font-size:14px;outline:none;transition:border .2s,background .2s;letter-spacing:.5px;}\n.login-input::placeholder{color:rgba(255,255,255,.25);}\n.login-input:focus{border-color:rgba(74,155,111,.7);background:rgba(255,255,255,.10);}\n.login-input.error{border-color:rgba(183,28,28,.7);animation:shake .35s ease;}\n@keyframes shake{0%,100%{transform:translateX(0);}20%{transform:translateX(-8px);}40%{transform:translateX(8px);}60%{transform:translateX(-5px);}80%{transform:translateX(5px);}}\n.toggle-pw{position:absolute;right:14px;background:none;border:none;color:rgba(255,255,255,.35);cursor:pointer;padding:0;display:flex;align-items:center;transition:color .2s;}\n.toggle-pw:hover{color:rgba(255,255,255,.7);}\n.toggle-pw svg{width:16px;height:16px;}\n.login-error{display:none;font-size:12px;color:#ef9a9a;margin-top:-8px;margin-bottom:12px;align-items:center;gap:5px;}\n.login-error.show{display:flex;}\n.login-btn{width:100%;padding:14px;background:var(--green-mid);border:none;border-radius:12px;color:#fff;font-family:'Sora',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .2s;margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px;}\n.login-btn:hover{background:var(--green-light);transform:translateY(-1px);box-shadow:0 8px 24px rgba(42,96,65,.4);}\n.login-btn:active{transform:translateY(0);}\n.login-btn.loading{opacity:.7;pointer-events:none;}\n.login-hint{margin-top:20px;padding-top:18px;border-top:1px solid rgba(255,255,255,.08);font-size:11.5px;color:rgba(255,255,255,.28);text-align:center;}\n.login-hint code{font-family:'JetBrains Mono',monospace;background:rgba(255,255,255,.08);padding:2px 6px;border-radius:4px;font-size:11px;}\n.logout-btn{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:var(--r-sm);color:rgba(255,255,255,.4);font-size:13px;font-weight:500;cursor:pointer;transition:all .18s;border:none;background:transparent;font-family:'Sora',sans-serif;width:100%;margin-top:auto;}\n.logout-btn:hover{background:rgba(183,28,28,.15);color:#ef9a9a;}\n.logout-btn svg{width:15px;height:15px;flex-shrink:0;}\n@media(max-width:1100px){.two-col,.wide-narrow{grid-template-columns:1fr;}.stats-row{grid-template-columns:1fr 1fr;}}\n@media(max-width:900px){.sidebar{width:60px;}.sidebar-logo h1,.sidebar-logo span,.nav-item span{display:none;}.nav-item{justify-content:center;padding:13px;}.main{margin-left:60px;padding:22px 18px;}.stats-row{grid-template-columns:1fr 1fr;}.three-col{grid-template-columns:1fr 1fr;}}\n@media(max-width:600px){.stats-row{grid-template-columns:1fr 1fr;}.three-col{grid-template-columns:1fr;}}\n";
const JS  = '\n(function() {\n  /* ======== STATE ======== */\n  var allOrders    = [];\n  var activeFilter = \'all\';\n  var lang         = \'en\';\n  var activePeriod = \'30\';\n  var timeSeg      = \'day\';\n  var SESSION_KEY  = \'gh_admin_secret\';\n\n  /* ======== NORMALIZE: API shape -> original shape ======== */\n  /* API returns: { id, shortId, customer:{name,phone,address,notes}, items:[{id,name,price,qty}], total, status, createdAt (ISO) } */\n  function normalizeOrder(o) {\n    var sec = o.createdAt ? Math.floor(new Date(o.createdAt).getTime() / 1000) : 0;\n    return {\n      id:              o.id,\n      orderId:         \'#\' + (o.shortId || o.id.slice(-6).toUpperCase()),\n      createdAt:       { seconds: sec },\n      customerName:    (o.customer || {}).name    || \'\',\n      customerPhone:   (o.customer || {}).phone   || \'\',\n      customerAddress: (o.customer || {}).address || \'\',\n      customerNotes:   (o.customer || {}).notes   || \'\',\n      status:          o.status || \'new\',\n      total:           o.total  || 0,\n      items: (o.items || []).map(function(i) {\n        return {\n          nameEn:   i.name,\n          name:     i.name,\n          quantity: i.qty,\n          price:    i.price,\n          unit:     i.unit     || \'\',\n          category: i.category || \'\',\n        };\n      }),\n    };\n  }\n\n  /* ======== HELPERS ======== */\n  function getSecret() { return sessionStorage.getItem(SESSION_KEY) || \'\'; }\n\n  function calcTotal(o) {\n    if (o.total) return +o.total;\n    return (o.items || []).reduce(function(s, i) { return s + (i.price || 0) * (i.quantity || 1); }, 0);\n  }\n\n  function formatDate(sec) {\n    var d = new Date(sec * 1000);\n    return d.toLocaleDateString(\'en-GB\', { day:\'2-digit\', month:\'short\', year:\'numeric\' })\n      + \'  \' + d.toTimeString().slice(0, 5);\n  }\n\n  function showToast(msg) {\n    var el = document.getElementById(\'toast\');\n    el.textContent = msg;\n    el.classList.add(\'show\');\n    setTimeout(function() { el.classList.remove(\'show\'); }, 2800);\n  }\n\n  function filterByPeriod(orders) {\n    if (activePeriod === \'all\') return orders;\n    var cutoff = Date.now() / 1000 - (+activePeriod) * 86400;\n    return orders.filter(function(o) { return (o.createdAt && o.createdAt.seconds || 0) >= cutoff; });\n  }\n\n  /* ======== LOAD FROM API (replaces Firebase client) ======== */\n  window.refreshOrders = function() { loadFromAPI(); };\n\n  function loadFromAPI() {\n    var secret = getSecret();\n    if (!secret) return;\n    document.getElementById(\'loading-indicator\').style.display = \'flex\';\n    document.getElementById(\'orders-grid\').innerHTML = \'\';\n\n    fetch(\'/api/admin/orders\', { headers: { \'x-admin-secret\': secret } })\n      .then(function(res) {\n        if (res.status === 403) {\n          sessionStorage.removeItem(SESSION_KEY);\n          location.reload();\n          return null;\n        }\n        return res.json();\n      })\n      .then(function(data) {\n        if (!data) return;\n        allOrders = (data.orders || []).map(normalizeOrder);\n        renderOrders();\n        renderAnalytics();\n        showToast(\'Orders refreshed\');\n      })\n      .catch(function(e) {\n        showToast(\'Error loading orders\');\n        document.getElementById(\'loading-indicator\').style.display = \'none\';\n      });\n  }\n\n  /* ======== UPDATE STATUS (replaces Firestore updateDoc) ======== */\n  window.updateStatus = function(id, status) {\n    var secret = getSecret();\n    var o = allOrders.find(function(x) { return x.id === id; });\n    if (!o) return;\n\n    // Optimistic update\n    o.status = status;\n    renderOrders();\n    renderAnalytics();\n    showToast(\'Updating status...\');\n\n    fetch(\'/api/admin/update-status\', {\n      method:  \'POST\',\n      headers: { \'Content-Type\': \'application/json\', \'x-admin-secret\': secret },\n      body:    JSON.stringify({ orderId: id, status: status }),\n    })\n      .then(function(res) {\n        if (res.ok) {\n          showToast(\'Order status updated!\');\n        } else {\n          showToast(\'Failed to update â€” try refreshing\');\n        }\n      })\n      .catch(function() { showToast(\'Network error\'); });\n  };\n\n  /* ======== ANALYTICS ======== */\n  function renderAnalytics() {\n    var orders = filterByPeriod(allOrders);\n    var totalRev  = orders.reduce(function(s, o) { return s + calcTotal(o); }, 0);\n    var delivered = orders.filter(function(o) { return o.status === \'delivered\'; }).length;\n    var rate      = orders.length ? Math.round(delivered / orders.length * 100) : 0;\n    var avg       = orders.length ? totalRev / orders.length : 0;\n    var totalItems = orders.reduce(function(s, o) {\n      return s + (o.items || []).reduce(function(si, i) { return si + (i.quantity || 1); }, 0);\n    }, 0);\n    var uniqueCustomers = (function() {\n      var seen = {};\n      orders.forEach(function(o) { if (o.customerName) seen[o.customerName] = 1; });\n      return Object.keys(seen).length;\n    })();\n\n    document.getElementById(\'a-revenue\').textContent   = \'\\u20ac\' + totalRev.toFixed(2);\n    document.getElementById(\'a-orders\').textContent    = orders.length;\n    document.getElementById(\'a-avg\').textContent       = \'\\u20ac\' + avg.toFixed(2);\n    document.getElementById(\'a-rate\').textContent      = rate + \'%\';\n    document.getElementById(\'kpi-items\').textContent   = totalItems;\n    document.getElementById(\'kpi-customers\').textContent = uniqueCustomers;\n\n    var prodQtyMap = {};\n    orders.forEach(function(o) {\n      (o.items || []).forEach(function(it) {\n        var k = it.nameEn || it.name || \'?\';\n        prodQtyMap[k] = (prodQtyMap[k] || 0) + (it.quantity || 1);\n      });\n    });\n    var topEntries = Object.entries(prodQtyMap).sort(function(a, b) { return b[1] - a[1]; });\n    document.getElementById(\'kpi-top-product\').textContent = topEntries[0] ? topEntries[0][0] : \'\\u2014\';\n\n    buildChartTime(orders);\n    buildTopProducts(orders, totalRev);\n    buildTopCustomers(orders);\n  }\n\n  /* ======== CHART ENGINE (preserved from original) ======== */\n  window.setTimeSeg = function(seg, btn) {\n    timeSeg = seg;\n    document.querySelectorAll(\'.seg-btn\').forEach(function(b) { b.classList.remove(\'active\'); });\n    btn.classList.add(\'active\');\n    buildChartTime(filterByPeriod(allOrders));\n  };\n\n  function drawBarChart(canvasId, labels, values, colors, opts) {\n    opts = opts || {};\n    var canvas = document.getElementById(canvasId);\n    if (!canvas) return;\n    var dpr = window.devicePixelRatio || 1;\n    var W   = canvas.getBoundingClientRect().width || 700;\n    var H   = 260;\n    canvas.width  = Math.round(W * dpr);\n    canvas.height = Math.round(H * dpr);\n    canvas.style.height = H + \'px\';\n    var ctx = canvas.getContext(\'2d\');\n    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);\n    var padL=54, padR=24, padT=20, padB=56;\n    var cw = W-padL-padR, ch = H-padT-padB;\n    var n = labels.length;\n    ctx.clearRect(0, 0, W, H);\n    if (n === 0) {\n      ctx.fillStyle=\'#8A8A8A\'; ctx.font=\'13px Sora,sans-serif\'; ctx.textAlign=\'center\';\n      ctx.fillText(\'No data for selected period\', W/2, H/2); return;\n    }\n    var maxV = Math.max.apply(null, values.concat([1]));\n    var barW = Math.max(8, Math.min(52, (cw/n)*0.62));\n    var gap  = cw/n;\n    for (var gi=0; gi<=5; gi++) {\n      var gy = padT+ch-(gi/5)*ch;\n      ctx.strokeStyle=\'#E2DDD5\'; ctx.lineWidth=1;\n      ctx.beginPath(); ctx.moveTo(padL,gy); ctx.lineTo(padL+cw,gy); ctx.stroke();\n      ctx.fillStyle=\'#8A8A8A\'; ctx.font=\'10px Sora,sans-serif\'; ctx.textAlign=\'right\';\n      ctx.fillText(opts.yFmt ? opts.yFmt(maxV*gi/5) : Math.round(maxV*gi/5), padL-6, gy+4);\n    }\n    values.forEach(function(v, i) {\n      var barH   = (v/maxV)*ch;\n      var x      = padL + i*gap + (gap-barW)/2;\n      var y      = padT + ch - barH;\n      var radius = Math.min(6, barW/2);\n      var color  = Array.isArray(colors) ? colors[i%colors.length] : (colors||\'#2A6041\');\n      ctx.beginPath();\n      ctx.moveTo(x+radius, y); ctx.lineTo(x+barW-radius, y);\n      ctx.arcTo(x+barW, y, x+barW, y+radius, radius);\n      ctx.lineTo(x+barW, y+barH); ctx.lineTo(x, y+barH);\n      ctx.arcTo(x, y, x+radius, y, radius); ctx.closePath();\n      ctx.fillStyle=color; ctx.fill();\n      if (v > 0) {\n        ctx.fillStyle=\'#1A1A1A\';\n        ctx.font=\'bold \'+Math.min(11,Math.max(9,barW/4))+\'px Sora,sans-serif\';\n        ctx.textAlign=\'center\';\n        ctx.fillText(opts.yFmt ? opts.yFmt(v) : v, x+barW/2, y-5);\n      }\n      var lbl = labels[i] || \'\';\n      var fs  = Math.min(11, Math.max(8, barW/4.5));\n      ctx.fillStyle=\'#4A4A4A\'; ctx.font=fs+\'px Sora,sans-serif\'; ctx.textAlign=\'center\';\n      if (n > 14) {\n        ctx.save(); ctx.translate(x+barW/2, padT+ch+12); ctx.rotate(-Math.PI/4);\n        ctx.fillText(lbl.length>6?lbl.slice(0,5)+\'...\':lbl, 0, 0); ctx.restore();\n      } else {\n        var mc = Math.max(3, Math.floor(barW/(fs*0.55)));\n        ctx.fillText(lbl.length>mc?lbl.slice(0,mc-1)+\'...\':lbl, x+barW/2, padT+ch+16);\n      }\n    });\n    ctx.strokeStyle=\'#E2DDD5\'; ctx.lineWidth=1.5;\n    ctx.beginPath(); ctx.moveTo(padL, padT+ch); ctx.lineTo(padL+cw, padT+ch); ctx.stroke();\n  }\n\n  function buildChartTime(orders) {\n    var buckets = {};\n    orders.forEach(function(o) {\n      var d = new Date((o.createdAt && o.createdAt.seconds || 0) * 1000);\n      var key;\n      if      (timeSeg === \'day\')   key = d.toISOString().slice(0, 10);\n      else if (timeSeg === \'month\') key = d.toISOString().slice(0, 7);\n      else                          key = String(d.getFullYear());\n      buckets[key] = (buckets[key] || 0) + calcTotal(o);\n    });\n    var sorted = Object.entries(buckets).sort(function(a, b) { return a[0].localeCompare(b[0]); });\n    var labels = sorted.map(function(e) {\n      var k = e[0];\n      if (timeSeg === \'day\') return new Date(k).toLocaleDateString(\'en-GB\', {day:\'2-digit\', month:\'short\'});\n      if (timeSeg === \'month\') {\n        var p = k.split(\'-\');\n        return new Date(+p[0], +p[1]-1).toLocaleDateString(\'en-GB\', {month:\'short\', year:\'2-digit\'});\n      }\n      return k;\n    });\n    var values = sorted.map(function(e) { return e[1]; });\n    var n = values.length || 1;\n    var colorArr = values.map(function(_, i) {\n      var t = i / (n-1||1);\n      var g = Math.round(64 + t*91);\n      return \'rgba(42,\'+g+\',65,\'+(0.55+t*0.45)+\')\';\n    });\n    drawBarChart(\'chartTime\', labels, values, colorArr, { yFmt: function(v) { return \'\\u20ac\'+v.toFixed(0); } });\n  }\n\n  function buildTopProducts(orders, totalRev) {\n    var prodMap = {};\n    orders.forEach(function(o) {\n      (o.items || []).forEach(function(it) {\n        var k = it.nameEn || it.name || \'?\';\n        if (!prodMap[k]) prodMap[k] = { name:k, qty:0, rev:0, cat:it.category||\'\' };\n        prodMap[k].qty += (it.quantity || 1);\n        prodMap[k].rev += (it.price || 0) * (it.quantity || 1);\n      });\n    });\n    var sorted = Object.values(prodMap).sort(function(a, b) { return b.rev - a.rev; });\n    var maxRev  = sorted[0] ? sorted[0].rev : 1;\n    var catColors = {\'Honey\':\'#FFF8E1\',\'Olive Oil\':\'#E8F5EE\',\'Olives\':\'#E8F5EE\',\'Oils\':\'#FBE9E7\'};\n    var catText   = {\'Honey\':\'#C8790A\',\'Olive Oil\':\'#2A6041\',\'Olives\':\'#2A6041\',\'Oils\':\'#6D4C41\'};\n    document.getElementById(\'top-products-body\').innerHTML = sorted.map(function(p, i) {\n      var pct = totalRev ? Math.round(p.rev/totalRev*100) : 0;\n      var w   = Math.round((p.rev/maxRev)*100);\n      return \'<tr>\'\n        +\'<td class="cell-rank"><div class="rank-pill">\'+(i+1)+\'</div></td>\'\n        +\'<td><span class="prod-name">\'+p.name+\'</span></td>\'\n        +\'<td><span class="prod-cat" style="background:\'+(catColors[p.cat]||\'#f0f0f0\')+\';color:\'+(catText[p.cat]||\'#666\')+\'">\'+( p.cat||\'\\u2014\')+\'</span></td>\'\n        +\'<td>\'+p.qty+\'</td>\'\n        +\'<td class="rev-val">\\u20ac\'+p.rev.toFixed(2)+\'</td>\'\n        +\'<td><div class="share-wrap"><div class="prog-bar-wrap"><div class="prog-bar" style="width:\'+w+\'%"></div></div><span class="share-pct">\'+pct+\'%</span></div></td>\'\n        +\'</tr>\';\n    }).join(\'\');\n  }\n\n  function buildTopCustomers(orders) {\n    var custMap = {};\n    allOrders.forEach(function(o) {\n      var k = o.customerName || \'Unknown\';\n      if (!custMap[k]) custMap[k] = { name:k, total:0, count:0, phone:o.customerPhone||\'\' };\n      custMap[k].total += calcTotal(o);\n      custMap[k].count++;\n    });\n    var sorted = Object.values(custMap).sort(function(a, b) { return b.total - a.total; });\n    document.getElementById(\'customers-body\').innerHTML = sorted.map(function(c, i) {\n      return \'<tr>\'\n        +\'<td class="cell-rank"><div class="rank-pill">\'+(i+1)+\'</div></td>\'\n        +\'<td><span class="prod-name">\'+c.name+\'</span></td>\'\n        +\'<td class="cell-mono">\'+(c.phone||\'\\u2014\')+\'</td>\'\n        +\'<td>\'+c.count+\' order\'+(c.count!==1?\'s\':\'\')+\'</td>\'\n        +\'<td class="rev-val" style="text-align:right">\\u20ac\'+c.total.toFixed(2)+\'</td>\'\n        +\'</tr>\';\n    }).join(\'\');\n  }\n\n  /* ======== ORDERS RENDER (preserved from original) ======== */\n  function updateOrderStats() {\n    var rev = allOrders.reduce(function(s, o) { return s + calcTotal(o); }, 0);\n    document.getElementById(\'stat-revenue\').textContent  = \'\\u20ac\' + rev.toFixed(2);\n    document.getElementById(\'stat-new\').textContent      = allOrders.filter(function(o){return o.status===\'new\';}).length;\n    document.getElementById(\'stat-confirmed\').textContent= allOrders.filter(function(o){return o.status===\'confirmed\';}).length;\n    document.getElementById(\'stat-delivered\').textContent= allOrders.filter(function(o){return o.status===\'delivered\';}).length;\n    [\'all\',\'new\',\'confirmed\',\'delivered\',\'cancelled\'].forEach(function(s) {\n      var el = document.getElementById(\'badge-\'+s);\n      if (el) el.textContent = s===\'all\' ? allOrders.length\n        : allOrders.filter(function(o) { return o.status===s; }).length;\n    });\n    document.getElementById(\'order-count-label\').textContent = allOrders.length + \' total orders\';\n  }\n\n  window.renderOrders = function() {\n    var grid    = document.getElementById(\'orders-grid\');\n    var loading = document.getElementById(\'loading-indicator\');\n    loading.style.display = \'none\';\n\n    var search   = document.getElementById(\'search-input\').value.toLowerCase();\n    var filtered = allOrders;\n    if (activeFilter !== \'all\') filtered = filtered.filter(function(o) { return o.status === activeFilter; });\n    if (search) filtered = filtered.filter(function(o) {\n      return (o.orderId||\'\').toLowerCase().includes(search)\n        || (o.customerName||\'\').toLowerCase().includes(search)\n        || (o.customerAddress||\'\').toLowerCase().includes(search)\n        || (o.customerPhone||\'\').toLowerCase().includes(search);\n    });\n\n    updateOrderStats();\n\n    if (filtered.length === 0) {\n      grid.innerHTML = \'<div class="empty-state"><div class="emoji">&#128203;</div><h3>No orders found</h3><p>Orders placed via the shop will appear here automatically.</p></div>\';\n      return;\n    }\n\n    var statusMap = {\n      \'new\':       \'<span class="status-badge new">&#x1F195; New</span>\',\n      \'confirmed\': \'<span class="status-badge confirmed">&#x2705; Confirmed</span>\',\n      \'delivered\': \'<span class="status-badge delivered">&#x1F4E6; Delivered</span>\',\n      \'cancelled\': \'<span class="status-badge cancelled">&#x274C; Cancelled</span>\',\n    };\n\n    grid.innerHTML = filtered.map(function(o, idx) {\n      var total = calcTotal(o);\n      var items = (o.items || []).map(function(i) {\n        return \'<tr>\'\n          +\'<td class="item-name">\'+(i.quantity||1)+\'x \'+(i.nameEn||i.name||\'Product\')+(i.unit?\' (\'+i.unit+\')\':\'\')+\'</td>\'\n          +\'<td class="item-price">\\u20ac\'+((i.price||0)*(i.quantity||1)).toFixed(2)+\'</td>\'\n          +\'</tr>\';\n      }).join(\'\');\n\n      var phone  = (o.customerPhone||\'\').replace(/\\s/g,\'\').replace(\'+\',\'\');\n      var waText = encodeURIComponent(\n        \'Hello \' + o.customerName + \', your GreenHarvest order \'\n        + (o.orderId||o.id) + \' is confirmed!\\nTotal: \\u20ac\' + total.toFixed(2)\n        + \'\\nPayment: Cash on delivery\\n\\nThank you!\'\n      );\n\n      var actions = \'\';\n      if (o.status!==\'confirmed\' && o.status!==\'delivered\')\n        actions += \'<button class="btn btn-confirm" onclick="updateStatus(\\\'\'+o.id+\'\\\',\\\'confirmed\\\')">&#x2705; Confirm</button>\';\n      if (o.status===\'confirmed\')\n        actions += \'<button class="btn btn-deliver" onclick="updateStatus(\\\'\'+o.id+\'\\\',\\\'delivered\\\')">&#x1F4E6; Delivered</button>\';\n      if (o.status!==\'cancelled\' && o.status!==\'delivered\')\n        actions += \'<button class="btn btn-cancel" onclick="updateStatus(\\\'\'+o.id+\'\\\',\\\'cancelled\\\')">Cancel</button>\';\n\n      return \'<div class="order-card" style="animation-delay:\'+idx*0.04+\'s">\'\n        +\'<div class="order-header">\'\n          +\'<div>\'\n            +\'<div class="order-id">\'+(o.orderId||\'#\'+o.id)+\'</div>\'\n            +\'<div class="order-date">\'+(o.createdAt?formatDate(o.createdAt.seconds):\'\\u2014\')+\'</div>\'\n          +\'</div>\'\n          +(statusMap[o.status]||statusMap[\'new\'])\n        +\'</div>\'\n        +\'<div class="order-body">\'\n          +\'<div class="customer-info">\'\n            +\'<div class="field"><svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><strong>\'+o.customerName+\'</strong></div>\'\n            +\'<div class="field"><svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>\'+(o.customerAddress||\'\\u2014\')+\'</div>\'\n            +\'<div class="field"><svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.36 12 19.79 19.79 0 0 1 1.21 3.18 2 2 0 0 1 3.18 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.15a16 16 0 0 0 8 8l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 24 17z"/></svg>\'+(o.customerPhone||\'\\u2014\')+\'</div>\'\n            +(o.customerNotes?\'<div class="field"><svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>\'+o.customerNotes+\'</div>\':\'\')\n          +\'</div>\'\n          +\'<table class="items-table">\'+items+\'</table>\'\n        +\'</div>\'\n        +\'<div class="order-footer">\'\n          +\'<div class="order-total"><div class="total-label">Total</div><div class="total-value">\\u20ac\'+total.toFixed(2)+\'</div></div>\'\n          +\'<div class="order-actions">\'\n            +\'<button class="btn btn-whatsapp" onclick="window.open(\\\'https://wa.me/\'+phone+\'?text=\'+waText+\'\\\',\\\'_blank\\\')">\'\n              +\'<svg fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347zM12 0C5.373 0 0 5.373 0 12c0 2.093.541 4.063 1.487 5.779L0 24l6.371-1.471A11.94 11.94 0 0 0 12 24c6.627 0 12-5.373 12-12S18.627 0 12 0zm0 21.818a9.818 9.818 0 0 1-5.013-1.371l-.36-.214-3.721.859.894-3.617-.235-.372A9.795 9.795 0 0 1 2.182 12C2.182 6.58 6.58 2.182 12 2.182S21.818 6.58 21.818 12 17.42 21.818 12 21.818z"/></svg>\'\n              +\'WhatsApp</button>\'\n            +\'<button class="btn btn-phone" onclick="window.open(\\\'tel:\'+phone+\'\\\')">\'\n              +\'<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.36 12 19.79 19.79 0 0 1 1.21 3.18 2 2 0 0 1 3.18 1h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.15a16 16 0 0 0 8 8l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 24 17z"/></svg>\'\n              +\'Call</button>\'\n            +actions\n          +\'</div>\'\n        +\'</div>\'\n        +\'</div>\';\n    }).join(\'\');\n  };\n\n  /* ======== TAB SWITCHING ======== */\n  window.showTab = function(tab) {\n    document.querySelectorAll(\'.tab-page\').forEach(function(p) { p.classList.remove(\'active\'); });\n    document.querySelectorAll(\'.nav-item\').forEach(function(b) { b.classList.remove(\'active\'); });\n    document.getElementById(\'tab-\'+tab).classList.add(\'active\');\n    document.getElementById(\'nav-\'+tab).classList.add(\'active\');\n    if (tab === \'analytics\') setTimeout(renderAnalytics, 50);\n  };\n\n  window.setFilter = function(filter, btn) {\n    activeFilter = filter;\n    document.querySelectorAll(\'.filter-tab\').forEach(function(b) { b.classList.remove(\'active\'); });\n    btn.classList.add(\'active\');\n    renderOrders();\n  };\n\n  window.setLang = function(l, btn) {\n    lang = l;\n    document.querySelectorAll(\'.lang-btn button\').forEach(function(b) { b.classList.remove(\'active\'); });\n    btn.classList.add(\'active\');\n  };\n\n  window.setPeriod = function(p, btn) {\n    activePeriod = p;\n    document.querySelectorAll(\'.period-btn\').forEach(function(b) { b.classList.remove(\'active\'); });\n    btn.classList.add(\'active\');\n    renderAnalytics();\n  };\n\n  /* ======== AUTH (validates against real API, no hardcoded password) ======== */\n  window.doLogin = function() {\n    var input = document.getElementById(\'psw-input\');\n    var err   = document.getElementById(\'login-error\');\n    var btn   = document.getElementById(\'login-btn\');\n\n    err.classList.remove(\'show\');\n    input.classList.remove(\'error\');\n    btn.classList.add(\'loading\');\n    btn.innerHTML = \'<div class="spinner" style="width:16px;height:16px;border-width:2px;border-color:rgba(255,255,255,.3);border-top-color:#fff"></div> Checking...\';\n\n    fetch(\'/api/admin/orders\', { headers: { \'x-admin-secret\': input.value } })\n      .then(function(res) {\n        if (res.ok) {\n          return res.json().then(function(data) {\n            sessionStorage.setItem(SESSION_KEY, input.value);\n            allOrders = (data.orders || []).map(normalizeOrder);\n            var screen = document.getElementById(\'login-screen\');\n            screen.style.transition = \'opacity .4s ease\';\n            screen.style.opacity = \'0\';\n            setTimeout(function() {\n              screen.classList.add(\'hidden\');\n              renderOrders();\n              renderAnalytics();\n            }, 400);\n          });\n        } else {\n          input.value = \'\';\n          input.classList.add(\'error\');\n          err.classList.add(\'show\');\n          setTimeout(function() { input.classList.remove(\'error\'); }, 500);\n          btn.classList.remove(\'loading\');\n          btn.innerHTML = \'<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> Sign In\';\n          input.focus();\n        }\n      })\n      .catch(function() {\n        err.textContent = \'Connection error. Please try again.\';\n        err.classList.add(\'show\');\n        btn.classList.remove(\'loading\');\n        btn.innerHTML = \'Sign In\';\n      });\n  };\n\n  window.doLogout = function() {\n    sessionStorage.removeItem(SESSION_KEY);\n    allOrders = [];\n    var screen = document.getElementById(\'login-screen\');\n    screen.classList.remove(\'hidden\');\n    screen.style.opacity = \'0\';\n    screen.style.transition = \'none\';\n    requestAnimationFrame(function() {\n      screen.style.transition = \'opacity .3s ease\';\n      screen.style.opacity = \'1\';\n    });\n    document.getElementById(\'psw-input\').value = \'\';\n    document.getElementById(\'login-error\').classList.remove(\'show\');\n    showToast(\'Logged out\');\n  };\n\n  window.togglePswVisibility = function() {\n    var input   = document.getElementById(\'psw-input\');\n    var eyeShow = document.getElementById(\'eye-show\');\n    var eyeHide = document.getElementById(\'eye-hide\');\n    if (input.type === \'password\') {\n      input.type = \'text\'; eyeShow.style.display = \'none\'; eyeHide.style.display = \'block\';\n    } else {\n      input.type = \'password\'; eyeShow.style.display = \'block\'; eyeHide.style.display = \'none\';\n    }\n  };\n\n  /* ======== INIT ======== */\n  document.getElementById(\'loading-indicator\').style.display = \'none\';\n\n  var saved = sessionStorage.getItem(SESSION_KEY);\n  if (saved) {\n    document.getElementById(\'login-screen\').classList.add(\'hidden\');\n    loadFromAPI();\n  }\n})();\n';

export default function AdminPage() {
  useEffect(() => {
    // Prevent search engines from indexing this page
    const meta = document.createElement('meta');
    meta.name = 'robots'; meta.content = 'noindex,nofollow';
    document.head.appendChild(meta);
  }, []);

  return (
    <>
      <Head>
        <title>Admin - GreenHarvest</title>
        <meta name="robots" content="noindex, nofollow" />
        <link
          href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
          rel="stylesheet"
        />
      </Head>

      <style dangerouslySetInnerHTML={{ __html: CSS }} />

      <div dangerouslySetInnerHTML={{ __html: `

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="login-bg">
    <div class="login-bg-circle c1"></div>
    <div class="login-bg-circle c2"></div>
    <div class="login-bg-circle c3"></div>
  </div>
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-icon">&#x1F33F;</div>
      <div class="logo-text"><h1>GreenHarvest</h1><span>Admin Dashboard</span></div>
    </div>
    <div class="login-title">Welcome back</div>
    <div class="login-sub">Enter your password to access the dashboard</div>
    <div class="login-field">
      <label>Password</label>
      <div class="login-input-wrap">
        <input class="login-input" id="psw-input" type="password" placeholder="&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;&#x2022;"
          onkeydown="if(event.key==='Enter')doLogin()" autocomplete="current-password"/>
        <button class="toggle-pw" onclick="togglePswVisibility()" tabindex="-1">
          <svg id="eye-show" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          <svg id="eye-hide" style="display:none" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
        </button>
      </div>
    </div>
    <div class="login-error" id="login-error">
      <svg width="13" height="13" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      Incorrect password. Please try again.
    </div>
    <button class="login-btn" id="login-btn" onclick="doLogin()">
      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
      Sign In
    </button>
    <div class="login-hint">Password is your <code>ADMIN_SECRET</code> from Vercel env vars</div>
  </div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo"><h1>&#x1F33F; GreenHarvest</h1><span>Admin Dashboard</span></div>
  <nav class="sidebar-nav">
    <button class="nav-item" id="nav-orders" onclick="showTab('orders')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
      <span>Orders</span>
    </button>
    <button class="nav-item active" id="nav-analytics" onclick="showTab('analytics')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      <span>Analytics</span>
    </button>
    <button class="nav-item" id="nav-products" onclick="showTab('products')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4A2 2 0 0 0 21 16z"/></svg>
      <span>Products</span>
    </button>
    <button class="nav-item" id="nav-customers" onclick="showTab('customers')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <span>Customers</span>
    </button>
  </nav>
  <div style="padding:10px 12px 16px;border-top:1px solid rgba(255,255,255,.07);">
    <button class="logout-btn" onclick="doLogout()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      <span>Logout</span>
    </button>
    <div style="padding:8px 2px 0;font-size:11px;color:rgba(255,255,255,.2);">v2.0 GreenHarvest</div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">

  <!-- ANALYTICS TAB -->
  <div class="tab-page active" id="tab-analytics">
    <div class="page-header">
      <div><h2>Analytics</h2><p id="analytics-subtitle">Performance overview</p></div>
      <div class="header-actions">
        <div class="period-bar">
          <button class="period-btn" onclick="setPeriod('7',this)">7d</button>
          <button class="period-btn active" onclick="setPeriod('30',this)">30d</button>
          <button class="period-btn" onclick="setPeriod('90',this)">90d</button>
          <button class="period-btn" onclick="setPeriod('all',this)">All</button>
        </div>
      </div>
    </div>
    <div class="stats-row">
      <div class="stat-card revenue"><div class="s-label">Total Revenue</div><div class="s-value" id="a-revenue">&#x20AC;0</div><div class="s-trend up" id="a-rev-trend">&#x2191; loading</div></div>
      <div class="stat-card new-c"><div class="s-label">Total Orders</div><div class="s-value" id="a-orders">0</div><div class="s-sub" id="a-orders-sub">all time</div></div>
      <div class="stat-card confirmed"><div class="s-label">Avg Order Value</div><div class="s-value" id="a-avg">&#x20AC;0</div><div class="s-sub">per order</div></div>
      <div class="stat-card delivered"><div class="s-label">Delivery Rate</div><div class="s-value" id="a-rate">0%</div><div class="s-sub">delivered / total</div></div>
    </div>
    <div class="three-col" style="margin-bottom:16px;">
      <div class="section-card"><div style="font-size:22px;margin-bottom:8px;">&#x1F4E6;</div><div style="font-size:24px;font-weight:900;color:var(--green-dark)" id="kpi-items">0</div><div style="font-size:11px;color:var(--text-light);margin-top:3px;">Total Items Sold</div></div>
      <div class="section-card"><div style="font-size:22px;margin-bottom:8px;">&#x1F465;</div><div style="font-size:24px;font-weight:900;color:var(--green-dark)" id="kpi-customers">0</div><div style="font-size:11px;color:var(--text-light);margin-top:3px;">Unique Customers</div></div>
      <div class="section-card"><div style="font-size:22px;margin-bottom:8px;">&#x1F3C6;</div><div style="font-size:18px;font-weight:900;color:var(--green-dark)" id="kpi-top-product">&#x2014;</div><div style="font-size:11px;color:var(--text-light);margin-top:3px;">Best-Selling Product</div></div>
    </div>
    <div class="section-card" style="margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
        <div><h3>Sales over Time</h3><div class="section-sub">Revenue grouped by day / month / year</div></div>
        <div class="seg-ctrl" id="time-seg">
          <button class="seg-btn active" onclick="setTimeSeg('day',this)">Day</button>
          <button class="seg-btn" onclick="setTimeSeg('month',this)">Month</button>
          <button class="seg-btn" onclick="setTimeSeg('year',this)">Year</button>
        </div>
      </div>
      <canvas id="chartTime" style="display:block;width:100%;height:260px;margin-top:16px;"></canvas>
    </div>
    <div class="section-card" style="margin-bottom:16px;">
      <h3>Top Products by Revenue</h3><div class="section-sub">Best performing products</div>
      <div class="table-shell"><div class="table-scroll"><table class="top-table"><thead><tr><th class="cell-rank">#</th><th>Product</th><th>Category</th><th>Qty</th><th>Revenue</th><th style="text-align:right">Share</th></tr></thead><tbody id="top-products-body"></tbody></table></div></div>
    </div>
    <div class="section-card">
      <h3>Customers</h3><div class="section-sub">All customers by total spend</div>
      <div class="table-shell"><div class="table-scroll"><table class="top-table"><thead><tr><th class="cell-rank">#</th><th>Customer</th><th>Phone</th><th>Orders</th><th style="text-align:right">Total Spend</th></tr></thead><tbody id="customers-body"></tbody></table></div></div>
    </div>
  </div>

  <!-- ORDERS TAB -->
  <div class="tab-page" id="tab-orders">
    <div class="page-header"><div><h2>Orders</h2><p id="order-count-label">Loading...</p></div></div>
    <div class="stats-row">
      <div class="stat-card revenue"><div class="s-label">Revenue</div><div class="s-value" id="stat-revenue">&#x20AC;0</div><div class="s-sub">all orders</div></div>
      <div class="stat-card new-c"><div class="s-label">New</div><div class="s-value" id="stat-new">0</div><div class="s-sub">awaiting</div></div>
      <div class="stat-card confirmed"><div class="s-label">Confirmed</div><div class="s-value" id="stat-confirmed">0</div><div class="s-sub">to deliver</div></div>
      <div class="stat-card delivered"><div class="s-label">Delivered</div><div class="s-value" id="stat-delivered">0</div><div class="s-sub">completed</div></div>
    </div>
    <div class="toolbar">
      <div class="filter-tabs" id="filter-tabs">
        <button class="filter-tab active" onclick="setFilter('all',this)">&#x1F33F; All <span class="badge" id="badge-all">0</span></button>
        <button class="filter-tab" onclick="setFilter('new',this)">&#x1F195; New <span class="badge" id="badge-new">0</span></button>
        <button class="filter-tab" onclick="setFilter('confirmed',this)">&#x2705; Confirmed <span class="badge" id="badge-confirmed">0</span></button>
        <button class="filter-tab" onclick="setFilter('delivered',this)">&#x1F4E6; Delivered <span class="badge" id="badge-delivered">0</span></button>
        <button class="filter-tab" onclick="setFilter('cancelled',this)">&#x274C; Cancelled <span class="badge" id="badge-cancelled">0</span></button>
      </div>
      <div class="search-box">
        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input id="search-input" placeholder="Search orders, customers..." oninput="renderOrders()"/>
      </div>
      <button class="refresh-btn" onclick="refreshOrders()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        Refresh
      </button>
    </div>
    <div id="orders-container">
      <div class="loading-state" id="loading-indicator"><div class="spinner"></div><span>Loading orders...</span></div>
      <div class="orders-grid" id="orders-grid"></div>
    </div>
  </div>

  <!-- PRODUCTS / CUSTOMERS placeholder -->
  <div class="tab-page" id="tab-products">
    <div class="page-header"><div><h2>Products</h2><p>Manage your product catalogue</p></div></div>
    <div class="empty-state"><div class="emoji">&#x1FAD9;</div><h3>Coming soon</h3><p>Product management will be available here.</p></div>
  </div>
  <div class="tab-page" id="tab-customers">
    <div class="page-header"><div><h2>Customers</h2><p>All registered customers</p></div></div>
    <div class="empty-state"><div class="emoji">&#x1F465;</div><h3>Coming soon</h3><p>Customer details will be available here.</p></div>
  </div>

</main>
<div class="toast" id="toast"></div>
` }} />

      <script dangerouslySetInnerHTML={{ __html: JS }} />
    </>
  );
}
